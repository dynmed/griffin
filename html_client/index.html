<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="foundation-6/css/foundation.css" />
    <link rel="stylesheet" href="foundation-6/foundation-icons/foundation-icons.css" />
    <link rel="stylesheet" href="main.css" />
  </head>

  <body>

    <div class="row">&nbsp;</div>

    <div class="row hide" id="secrets">
      <h4>Secret Vault</h4>
      <div class="large-12 columns">
        <div class="row">
          <div class="large-3 columns"><!-- filters -->
            <div class="row">
              <div class="large-12 columns">
                <label>Search
                  <input type="text" id="secret-search" />
                </label>
              </div>
            </div>
	    <div class="row">
	      <div class="large-12 columns">
		<a href="#" class="button small" id="add-secret"
                   data-open="add-secret-form">
                  Add Secret
                </a>
	      </div>
	    </div>
          </div><!-- end filters -->

          <!-- secret-list -->
          <div class="large-9 columns" id="secret-list"></div>
          <!-- end secret-list -->

        </div>
      </div>
    </div><!-- #secrets -->

    <div class="reveal" id="add-secret-form" data-reveal>
      <h4>Add New Secret</h4>

      <div class="callout">
        <form action="#" data-abide novalidate>
          <input id="add-secret-id" type="hidden" />
          <div data-abide-error role="alert" class="alert callout" style="display: none">
            <p><i class="fi-alert"></i> Please fix the errors below.</p>
          </div>
          <label id="add-site-lbl" for="add-site">Site:
            <input type="text" id="add-site" />
          </label>
          <span class="form-error" id="add-site-err"></span>
          <label id="add-username-lbl" for="add-username">Username:
            <input type="text" id="add-username" />
          </label>
          <span class="form-error" id="add-username-err"></span>
          <label id="add-password-1-lbl" for="add-password-1">Password:
            <div class="password-container">
              <input type="password" id="add-password-1" />
              <i class="fi-eye" id="toggle-show-secret"></i>
            </div>
          </label>
          <span class="form-error" id="add-password-1-err"></span>
          <label id="add-password-2-lbl" for="add-password-2">Repeat Password:
            <input type="password" id="add-password-2" />
          </label>
          <span class="form-error" id="add-password-2-err"></span>
          <div class="row">
            <a id="generate-secret" href="#" class="button secondary">
              Generate
            </a>
            <a id="add-secret-submit" href="#" class="button float-right">
              Save
            </a>
          </div>
          <small>
            <a href="#" id="toggle-password-options">Password Options</a>
          </small>
          <div class="row" id="password-options" style="display: none">
            <fieldset class="fieldset">
              <div class="row">
                <div class="medium-2 small-6 columns">
                  <label for="generate-lower" class="text-right">
                    Lowercase
                  </label>
                </div>
                <div class="medium-1 small-6 columns">
                  <input id="generate-lower" type="checkbox">
                </div>
                <div class="medium-2 small-6 columns">
                  <label for="generate-upper" class="text-right">
                    Uppercase
                  </label>
                </div>
                <div class="medium-1 small-6 columns">
                  <input id="generate-upper" type="checkbox">
                </div>
                <div class="medium-2 small-6 columns">
                  <label for="generate-numbers" class="text-right">
                    Numbers
                  </label>
                </div>
                <div class="medium-1 small-6 columns">
                  <input id="generate-numbers" type="checkbox">
                </div>
                <div class="medium-2 small-6 columns">
                  <label for="generate-special" class="text-right">
                    Special
                  </label>
                </div>
                <div class="medium-1 small-6 columns">
                  <input id="generate-special" type="checkbox">
                </div>
              </div>
              <div class="row">
                <div class="medium-2 small-6 columns">
                  <label for="generate-length" class="text-right">
                    Length
                  </label>
                </div>
                <div class="medium-2 small-6 columns">
                  <input id="generate-length" type="number">
                </div>
                <div class="medium-4 small-6 columns">
                  <label for="generate-exclude-similar" class="text-right">
                    Exclude look-alike characters
                  </label>
                </div>
                <div class="medium-1 small-6 columns">
                  <input id="generate-exclude-similar" type="checkbox">
                </div>
                <div class="medium-3 small-6 columns">
		  <label class="text-right">
                    <a href="#" id="import-json"
                       data-open="import-json-form">Import JSON</a>
                  </label>
                </div>
              </div>
            </fieldset>
          </div>
        </form>
      </div>

      <button class="close-button" type="button" data-close>
        <span aria-hidden="true">&times;</span>
      </button>

    </div><!-- #add-secret-form -->

    <div class="reveal" id="import-json-form" data-reveal>
      <h4>Import secrets from JSON</h4>
      <!-- TODO hyperlink to LastPass conversion script -->
      <div data-abide-error role="alert" class="alert callout"
           style="display: none">
        <p><i class="fi-alert"></i> <span id="import-error-msg"></span></p>
      </div>
      <div class="callout">
        <form action="#" data-abide novalidate>
          <div class="row">
            <div class="small-3 columns">
              <label for="import-json-file">
                Select File
              </label>
            </div>
            <div class="small-4 columns">
              <input id="import-json-file" type="file" />
            </div>
            <div class="small-5 columns">
              <a id="import-json-submit" href="#" class="button float-right">
                Import
              </a>
            </div>
          </div>
        </form>
      </div>
      <button class="close-button" type="button" data-close>
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="row hide" id="authentication">
      <div class="medium-6 medium-centered columns">
        <div class="callout">
          <form action="#">
            <h4 class="text-center">Log in to access your account</h4>
            <div data-abide-error role="alert" class="alert callout"
                 style="display: none">
              <p><i class="fi-alert"></i>
                Your username or passphrase was incorrect.
              </p>
            </div>
            <label>Email:
              <input type="text" id="username" placeholder="name@example.com" />
            </label>
            <label>Passphrase:
              <input type="password" id="master-passphrase"
                     placeholder="Your complex passphrase"/>
            </label>
            <label>
              <a id="login-submit" href="#" class="button expand">Submit</a>
            </label>
            <p>
              <a href="#" id="show-registration">Register a new account</a>
            </p>
          </form>
        </div>
      </div>
    </div>
    
    <div class="row hide" id="registration">
      <div class="medium-6 medium-centered columns">
        <div class="callout">
          <h4 class="text-center">Register a new account</h4>
          <form action="#">
            <div data-abide-error role="alert" class="alert callout"
                 style="display: none">
              <p><i class="fi-alert"></i> Please fix the errors below.</p>
            </div>
            <label id="username-reg-lbl" for="username-reg">Email:
              <input type="text" id="username-reg"
                     placeholder="name@example.com" />
            </label>
            <span class="form-error" id="username-reg-err"></span>
            <label id="master-passphrase-reg-lbl"
                   for="master-passphrase-reg">Passphrase:
              <input type="password" id="master-passphrase-reg"
                     placeholder="Your complex passphrase"/>
            </label>
            <span class="form-error" id="master-passphrase-reg-err"></span>
            <label id="master-passphrase-reg-2-lbl"
                   for="master-passphrase-reg-2">Repeat Passphrase:
              <input type="password" id="master-passphrase-reg-2"
                     placeholder="Your complex passphrase again"/>
            </label>
            <span class="form-error" id="master-passphrase-reg-2-err"></span>
            <label>
              <a id="registration-submit" href="#" class="button expand">
                Submit
              </a>
            </label>
            <p>
              <a href="#" id="show-authentication">I already have an account</a>
            </p>
          </form>
        </div>
      </div>
    </div>

    <!-- TODO download minimal set of foundation components:
         http://foundation.zurb.com/sites/download.html/
      -->
    <script src="foundation-6/js/vendor/jquery.js"></script>
    <script src="foundation-6/js/vendor/what-input.js"></script>
    <script src="foundation-6/js/vendor/foundation.js"></script>
    <script src="sodium.min.js"></script>
    <script src="client.js"></script>
<script>
// navigate between UI views
function displayUIView(view) {
    var views = ["secrets", "authentication", "registration"];
    for (var i = 0 ; i < views.length ; i++) {
        // display only the view requested
        if (views[i] != view) {
            jQuery("#" + views[i]).addClass("hide");
        }
        else {
            jQuery("#" + views[i]).removeClass("hide");
        }
    }
}
    
// display table of stored secrets
function displaySecrets(griffin, query) {
    // show the secrets UI
    displayUIView("secrets");
    var secrets = griffin.getSecrets(query);
    // clear out existing list
    var secretList = jQuery("#secret-list").empty();

    for (var i = 0 ; i < secrets.length ; i++) {
        var secret = jQuery(
            `<div class="row secret">
               <div class="small-1 columns site-icon">
                          <i class="fi-web"></i>
                        </div>
                        <div class="small-11 columns">
                          <h4>-</h4>
                          <small class="username"></small>
                        </div>
                        <div class="ui-control-panel">
                          <div class="ui-control">
                            <i class="fi-lock"></i>
                          </div>
                          <div class="ui-control">
                            <i class="fi-torso"></i>
                          </div>
                          <div class="ui-control secondary">
                            <i class="fi-pencil"></i>
                          </div>
                          <div class="ui-control secondary">
                            <i class="fi-trash"></i>
                          </div>
                        </div>
                      </div>`
        );
        jQuery(secret).find("h4").text(secrets[i]["data"]["site"]);
        jQuery(secret).find("small").text(secrets[i]["data"]["username"]);
        // store the ID on the row so we can reference this secret from the UI
        jQuery(secret).data("index", secrets[i].id);
        // make row selectable
        jQuery(secret).click(function() {
            selectRow(this);
        });
        secretList.append(secret);
    }

    // set up handlers for secret editing/copying UI buttons
    jQuery("div.ui-control").on("click", function() {
        var secretId = jQuery(this).closest("div.secret").data("index");
        // TODO convert to template + jQuery insert
        // copy password
        if (jQuery(this).find("i").hasClass("fi-lock")) {
            var temp = document.createElement("input");
            temp.setAttribute("value", griffin.getSecret(secretId).data.password);
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            // TODO set timer to clear the clipboard
        }
        // copy username
        else if (jQuery(this).find("i").hasClass("fi-torso")) {
            var temp = document.createElement("input");
            temp.setAttribute("value", griffin.getSecret(secretId).data.username);
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            // TODO set timer to clear the clipboard
        }
        // edit secret
        else if (jQuery(this).find("i").hasClass("fi-pencil")) {
            // populate "Add Secret" form with existing values
            var existing = griffin.getSecret(secretId);
            jQuery("#add-secret-id").val(existing.id);
            jQuery("#add-site").val(existing.data.site);
            jQuery("#add-username").val(existing.data.username);
            jQuery("#add-password-1").val(existing.data.password);
            jQuery("#add-password-2").val(existing.data.password);
            jQuery("#add-secret-form").foundation("open");
        }
        // delete secret
        else {
            griffin.deleteSecret(secretId);
            // TODO should display with query intact
            displaySecrets(griffin);
        }
    });
}

function selectRow(row) {
    // deselect the other rows
    jQuery(".secret").removeClass("selected").find(".ui-control-panel").hide();
    // select the new row and show the UI
    jQuery(row).addClass("selected").find(".ui-control-panel").show();
}

// destroy session and display log in form
// TODO destroy existing session
function authenticateUser(griffin) {
    var session = griffin.session;
    // TODO null master passphrase out after timeout
    session.username = jQuery("#username").val();
    session.masterPassphrase = jQuery("#master-passphrase").val();

    // attempt to decrypt keyset with master passphrase
    if (griffin.loadKeys()) {
        displaySecrets(griffin);
    }
    else {
        // show top level error message
        jQuery("#authentication").find("div.alert").show();
    }
}

function registerUser(griffin) {
    // container for validation errors
    var errors = {};

    // TODO better email validation
    var email = jQuery("#username-reg").val();
    if (!email.length) {
        errors["username-reg"] = "Email address is required.";
    }

    // validate passphrase
    var phrase1 = jQuery("#master-passphrase-reg").val();
    var phrase2 = jQuery("#master-passphrase-reg-2").val();
    if (!phrase1.length) {
        errors["master-passphrase-reg"] = "Passphrase is required.";
    }
    else if (phrase1 !== phrase2) {
        errors["master-passphrase-reg-2"] = "Your passphrase does not match.";
    }

    // display any registration errors
    registrationErrors(errors);

    // prevent registration if there were validation errors
    if (Object.keys(errors).length) {
        return;
    }

    // create the new keyset
    var session = griffin.session;
    session.username = jQuery("#username-reg").val();
    session.masterPassphrase = phrase1;
    session.active = true;
    // generate encryption and signing keys
    try {
        griffin.generateKeys(email);
    }
    catch(e) {
        alert("problem generating keys");
    }

    // show the secrets UI
    displaySecrets(griffin);    
}

// TODO this could be merged with addSecretErrors and importJSONErrors
function registrationErrors(errors) {
    // clear all existing errors
    jQuery("#registration").find("div.alert").hide();
    jQuery("#registration").find("label").removeClass("is-invalid-label");
    jQuery("#registration").find("span.form-error")
                           .removeClass("is-visible")
                           .text("");
    if (errors == null) {
        return;
    }

    // show top level error message
    jQuery("#registration").find("div.alert").show();

    // display new error messages
    for (var field in errors) {
        if (errors.hasOwnProperty(field)) {
            jQuery("#" + field + "-lbl").addClass("is-invalid-label");
            jQuery("#" + field + "-err").addClass("is-visible");
            jQuery("#" + field + "-err").text(errors[field]);
        }
    }    
}

function addSecret(griffin) {
    // container for validation errors
    var errors = {};

    // read field values
    var secretId = jQuery("#add-secret-id").val();
    var site = jQuery("#add-site").val();
    var username = jQuery("#add-username").val();
    var password1 = jQuery("#add-password-1").val();
    var password2 = jQuery("#add-password-2").val();

    // validate field values
    if (!site.length) {
        errors["add-site"] = "Site is required.";
    }

    if (!password1.length) {
        errors["add-password-1"] = "Enter password.";
    }

    if (!password2.length) {
        errors["add-password-2"] = "Enter password again.";
    }
    else if (password1 != password2) {
        errors["add-password-2"] = "Passwords do not match.";
    }

    // prevent secret creation if there were validation errors
    if (Object.keys(errors).length) {
        addSecretErrors(errors);
        return;
    }

    // valid submission so create the new GriffinSecret
    var secret = new GriffinSecret({
        site: site,
        username: username,
        password: password1
    });
    // if we are editing an existing secret set the ID, otherwise null
    secret.id = (secretId != "") ? parseInt(secretId) : null;
    secret.touch();
    griffin.saveSecret(secret);

    // close the form
    jQuery("#add-secret-form").foundation("close");

    // re-draw the table of secrets
    displaySecrets(griffin);
}

// display Add Secret form validation errors
// args: Object errors or null to clear all error messages
function addSecretErrors(errors) {
    // clear all existing errors
    jQuery("#add-secret-form").find("div.alert").hide();
    jQuery("#add-secret-form").find("label").removeClass("is-invalid-label");
    jQuery("#add-secret-form").find("span.form-error")
                              .removeClass("is-visible")
                              .text("");

    if (errors == null) {
        // re-mask password fields
        jQuery("#add-password-1,#add-password-2").attr("type", "password");
        // reset button state
        jQuery("#toggle-show-secret").removeClass("alert");
        return;
    }

    // show top level error message
    jQuery("#add-secret-form").find("div.alert").show();

    // display new error messages
    for (var field in errors) {
        if (errors.hasOwnProperty(field)) {
            jQuery("#" + field + "-lbl").addClass("is-invalid-label");
            jQuery("#" + field + "-err").addClass("is-visible");
            jQuery("#" + field + "-err").text(errors[field]);
        }
    }
}

function setupEventHandlers(griffin) {
    // set up handler for login form submit
    jQuery("#login-submit").click(function() {
        authenticateUser(griffin);
    });

    // set up handler for registration link
    jQuery("#show-registration").click(function() {
        // display registration form
        displayUIView("registration");
        // set up handler for registration submission
        jQuery("#registration-submit").click(function() {
            registerUser(griffin);
        });
    });

    // set up handler for existing user link
    jQuery("#show-authentication").click(function() {
        // take user back to existing login form
        displayUIView("authentication");
    });

    // set up handlers for add new secret form
    jQuery("#add-secret-submit").click(function() {
        addSecret(griffin);
    });
    jQuery("#add-secret-form").on("closed.zf.reveal", function() {
        // reset the form when the dialog is closed
        jQuery(this).find("input").val("");
        addSecretErrors(null);
    });
    // write config from keyset to form fields
    jQuery("#add-secret-form").on("open.zf.reveal", function() {
        jQuery.each(
            ["generate-lower", "generate-upper", "generate-numbers",
             "generate-special", "generate-length", "generate-exclude-similar"],
            function() {
                var value = griffin.config[this];
                if (value === true) {
                    jQuery("#" + this).prop("checked", true);
                }
                else {
                    jQuery("#" + this).val(value);
                }
            });
    });
    // hook up handler to show/hide password fields
    jQuery("#toggle-show-secret").click(function() {
        var masked = (jQuery("#add-password-1").attr("type") == "password") ?
                     true : false;
        // toggle the shown/hidden state of the password fields
        jQuery("#add-password-1,#add-password-2").attr(
            "type",
            (masked) ? "text" : "password"
        );
        // toggle the button state
        jQuery(this).toggleClass("alert");
    });
    jQuery("#toggle-password-options").click(function() {
        jQuery("#password-options").slideToggle();
    });
    // add handlers for password options
    jQuery("#password-options").find("input").change(function() {
        var name = jQuery(this).attr("id");
        var value = (jQuery(this).attr("type") == "checkbox") ?
                    jQuery(this).prop("checked") : parseInt(jQuery(this).val());
        // TODO expose griffin.saveConfig instead
        griffin.config[name] = value;
        griffin.storeKeys();
    });
    // handler for generate password button
    jQuery("#generate-secret").click(function() {
        var password = griffin.generatePassword();
        jQuery("#add-password-1,#add-password-2").val(password);
    });
    // submit JSON to be imported
    jQuery("#import-json-submit").click(function() {
        importJSON(griffin);
    });
    jQuery("#import-json-form").on("closed.zf.reveal", function() {
        // reset the form when the dialog is closed
        jQuery(this).find("input").val("");
        jQuery(this).find("div.alert").hide();
    });
    // search handler
    jQuery("#secret-search").on("keyup paste", function(evt) {
        var query = jQuery(this).val();
        if (query.length) {
            return displaySecrets(griffin, query);
        }
        displaySecrets(griffin);
    });
    // UI elements on click, hover
    jQuery("div.secret").on("click", function(evt) {
        // var index = jQuery(this).closest("tr").data("index");
        var row = jQuery(this).closest("div.secret");
        console.log(row);
    });
}

function importJSONErrors(errors) {
    // clear existing errors
    jQuery("#import-error-msg").text("");
    jQuery("#import-json-form").find("div.alert").hide();
    if (errors == null) {
        // reset file picker
        jQuery("#import-json-file").val("");
        return;
    }
    jQuery("#import-error-msg").text(errors["import-json-file"]);
    jQuery("#import-json-form").find("div.alert").show();
}

/* read a JSON array from an imported file and create new GriffinSecrets
 *
 * args: GriffinKeySet
 */
function importJSON(griffin) {
    // container for validation errors
    var errors = {};
    var file = jQuery("#import-json-file").get(0).files[0];
    var reader = new FileReader();
    // callback to process data read from the file
    reader.onload = function createNewSecrets(evt) {
        // container for parsed JSON secrets
        var secrets = null;
        var text = evt.target.result;
        // attempt to parse file contents as JSON
        try {
            secrets = JSON.parse(reader.result);
        }
        catch (e) {
            errors["import-json-file"] = "File contains invalid JSON";
        }
        // validation errors
        if (Object.keys(errors).length) {
            importJSONErrors(errors);
            return;
        }
        // process JSON into new GriffinSecrets
        // TODO display progress bar
        for (var i = 0 ; i < secrets.length ; i++) {
            var secret = new GriffinSecret({
                site: secrets[i].site,
                username: secrets[i].username,
                password: secrets[i].password
            });
            secret.touch();
            griffin.saveSecret(secret);
        }
        // close the import JSON form
        jQuery("#import-json-form").foundation("close");

        // re-draw the table of secrets
        displaySecrets(griffin);
    };
    
    
    // make sure a file has been selected
    if (file === undefined) {
        errors["import-json-file"] = "No file selected";
    }
    // attempt to read from input file
    else {
        try {
            reader.readAsText(file);
        }
        catch (e) {
            errors["import-json-file"] = "Unable to read from file";
        }
    }

    // validation errors
    if (Object.keys(errors).length) {
        importJSONErrors(errors);
        return;
    }
}

var griffin = new GriffinKeySet();
setupEventHandlers(griffin);

// display login form
displayUIView("authentication");

jQuery(document).foundation();
    </script>
  </body>
</html>
