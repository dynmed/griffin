<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="foundation-5/css/foundation.css" />
    <script src="foundation-5/js/vendor/modernizr.js"></script>
  </head>

  <body>

    <div class="row">&nbsp;</div>

    <div class="row hide">
      <h4>Sites</h4>
      <div class="large-12 columns">
        <div class="row panel">
          <table id="sites">
            <thead>
              <tr>
                <th>Site</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row hide" id="authentication">
      <div class="medium-6 medium-centered columns">
        <div class="panel radius">
          <form action="#">
            <h4 class="text-center">Log in to access your account</h4>
            <label>Email:
              <input type="text" id="username" placeholder="name@example.com" />
            </label>
            <label>Passphrase:
              <input type="password" id="master-passphrase" placeholder="Your complex passphrase"/>
            </label>
            <label>
              <a id="login-submit" href="#" class="button expand">Submit</a>
            </label>
            <p><a href="#" id="show-registration">Register a new account</a></p>
          </form>
        </div>
      </div>
    </div>
    

    <div class="row hide" id="registration">
      <div class="medium-6 medium-centered columns panel radius">
        <form action="#">
          <div class="row">
            <div class="large-12 columns">
              <h4 class="text-center">Register a new account</h4>
            </div>
          </div>
          <div class="row">
            <div class="large-12 columns">
              <label id="username-reg-lbl" for="username-reg">Email:
                <input type="text" id="username-reg" placeholder="name@example.com" />
              </label>
              <small id="username-reg-err"></small>
            </div>
          </div>
          <div class="row">
            <div class="large-12 columns">
              <label id="master-passphrase-reg-lbl"
                     for="master-passphrase-reg">Passphrase:
                <input type="password" id="master-passphrase-reg"
                       placeholder="Your complex passphrase"/>
              </label>
              <small id="master-passphrase-reg-err"></small>
            </div>
          </div>
          <div class="row">
            <div class="large-12 columns">
              <label id="master-passphrase-reg-2-lbl"
                     for="master-passphrase-reg-2">Repeat Passphrase:
                <input type="password" id="master-passphrase-reg-2"
                       placeholder="Your complex passphrase again"/>
              </label>
              <small id="master-passphrase-reg-2-err"></small>
            </div>
          </div>
          <div class="row">
            <div class="large-12 columns">
              <label>
                <a id="registration-submit" href="#" class="button expand">Submit</a>
              </label>
              <p><a href="#" id="show-authentication">I already have an account</a></p>
            </div>
          </div>
        </form>
      </div><!-- .medium-6 medium-centered columns panel radius -->
    </div>
    
    <!-- TODO download minimal set of foundation components:
         http://foundation.zurb.com/sites/download.html/
      -->
    <script src="foundation-5/js/vendor/jquery.js"></script>
    <script src="foundation-5/js/foundation.min.js"></script>
    <script src="sodium.min.js"></script>
    <script src="client.js"></script>
    <script>
// shortcut for document.getElementById
var elemById = function(id) { return document.getElementById(id); };

// display table of stored secrets
function displaySecrets(sites) {
    var newTbody = document.createElement("tbody");
    for (var i = 0 ; i < sites.length ; i++) {
        var row = newTbody.insertRow();
        var dCell = row.insertCell();
        var domain = document.createTextNode(sites[i]["domain"]);
        dCell.appendChild(domain);
        var uCell = row.insertCell();
        var username = document.createTextNode(sites[i]["username"]);
        uCell.appendChild(username);
    }
    var oldTbody = elemById("sites").getElementsByTagName("tbody")[0];
    oldTbody.parentNode.replaceChild(newTbody, oldTbody);
}

// destroy session and display log in form
// TODO destroy existing session
function authenticateUser(griffin) {
    var session = griffin.session;
    // TODO null master passphrase out after timeout
    session.username = elemById("username").value;
    session.masterPassphrase = elemById("master-passphrase").value;

    // attempt to decrypt keyset with master passphrase
    griffin.loadKeys();
}

function registerUser(griffin) {
    // container for validation errors
    var errors = {};

    // TODO better email validation
    var email = elemById("username-reg").value;
    if (!email.length) {
        errors["username-reg"] = "Email address is required.";
    }

    // validate passphrase
    var phrase1 = elemById("master-passphrase-reg").value;
    var phrase2 = elemById("master-passphrase-reg-2").value;
    if (!phrase1.length) {
        errors["master-passphrase-reg"] = "Passphrase is required.";
    }
    else if (phrase1 !== phrase2) {
        errors["master-passphrase-reg-2"] = "Your passphrase does not match.";
    }

    // prevent registration if there were validation errors
    if (Object.keys(errors).length) {
        showRegistrationErrors(errors);
        return;
    }

    // no validation errors so clear the UI of error messages
    hideRegistrationErrors();

    // create the new keyset
    var session = griffin.session;
    session.username = elemById("username-reg").value;
    session.masterPassphrase = phrase1;
    session.active = true;
    // generate encryption and signing keys
    try {
        griffin.generateKeys(email);
    }
    catch(e) {
        alert("problem generating keys");
    }
}

// TODO
function hideRegistrationErrors() {
    jQuery("small.error").text("");
    jQuery("label.error, small.error").removeClass("error");
}

function showRegistrationErrors(errors) {
    // clear any existing errors first
    hideRegistrationErrors();

    for (var field in errors) {
        if (errors.hasOwnProperty(field)) {
            elemById(field + "-lbl").className = "error";
            elemById(field + "-err").className = "error";
            elemById(field + "-err").textContent = errors[field];
        }
    }
}

// TODO don't need to keep re-adding all these event handlers; add them in one function

function doLoginPrompt(griffin) {
    elemById("authentication").style.display = "block";
    // set up handler for login form submit
    elemById("login-submit").onclick = function() {
        authenticateUser(griffin);
    };
    // set up handler for registration link
    elemById("show-registration").onclick = function() {
        elemById("authentication").style.display = "none";
        elemById("registration").style.display = "block";
        // set up handler for registration submission
        elemById("registration-submit").onclick = function() {
            registerUser(griffin);
        };
    };
    // set up handler for existing user link
    elemById("show-authentication").onclick = function() {
        // take user back to existing login form
        elemById("registration").style.display = "none";
        elemById("authentication").style.display = "block";
    };
}


var griffin = new GriffinKeySet();
doLoginPrompt(griffin);

    /*
    var sites = [{"domain": "example.com", "username": "alice"},
                 {"domain": "example.net", "username": "robert"}];

    displaySecrets(sites);
    */

    </script>
  </body>
</html>
